# TicketLeader — Technical Reference

## Architecture Overview

```
┌─────────────────────────────────────────────────────┐
│                    Client (React)                    │
│  Pages: Login · Dashboard · LiveQueue · Stadium      │
│  Socket.IO client · Three.js canvas · REST API calls │
└────────────────────┬────────────────────────────────┘
                     │ HTTPS + WSS
┌────────────────────▼────────────────────────────────┐
│              Node.js / Express Server                │
│  Routes: auth · queue · content · games · tts · sync │
│  Socket.IO server · JWT middleware · CORS            │
└──────┬──────────────────────────┬───────────────────┘
       │                          │
┌──────▼──────┐          ┌────────▼────────┐
│  MongoDB    │          │  Google Gemini   │
│  Atlas      │          │  2.5 Flash API   │
│  (Mongoose) │          │  (AI Trivia)     │
└─────────────┘          └─────────────────┘
```

---

## Bot Detection Stack (6 Layers)

### Layer 1 — reCAPTCHA (Signup/Login)
Removed from UI; server does not enforce. Replaced by trivia gate which is more effective for ticketing-specific abuse.

### Layer 2 — AI Trivia Gate
- Before joining any queue, users answer an artist-specific trivia question
- Questions generated by Google Gemini 2.5 Flash and saved to MongoDB (`TriviaQuestion` collection)
- Server verifies `triviaQuestionId` + `triviaAnswer` against DB before granting queue entry
- Static DB questions served first; Gemini generates more if pool < 15
- Questions cycle using `seenTriviaIds` exclusion — same question never repeats within 30 rounds
- Passthrough only if no questions exist at all (null-safe)

### Layer 3 — IP Flagging
- `QueueSession` stores IP on join
- Multiple active sessions from same IP → `isFlagged = true`
- Flagged users get queue position penalty (-20 trust)

### Layer 4 — Response Timing Analysis
- Gate question records `shownAt` timestamp
- Answers < 1500ms counted as `fastWrongAttempts`
- Combined with wrong attempts → bot scoring formula

### Layer 5 — Behavioral Tracking
- `BehaviorCollector` utility streams mouse movement, scroll events, click patterns
- Data POSTed to `/api/games/behavior/stream` every 5 seconds
- Server scores behavioral fingerprint against human baseline

### Layer 6 — WebAuthn Biometric Verification
- Triggered when all 3 bot flags trip simultaneously
- Redirects to `/verify` — uses browser's native Face ID / Touch ID / fingerprint
- Credential verified server-side; session unlocked on pass

---

## Trust Score System

```
Base score: 50 points

+5   Easy trivia correct
+10  Medium trivia correct
+15  Hard trivia correct
+3–5 Poll participation
+2   Human-like response time (2–8 seconds)
+1   Per minute in queue (max +20)

-20  Suspicious IP (multiple sessions)
-10  Each bot-like behavioral flag
```

### Trust Levels
| Level | Range | Effect |
|-------|-------|--------|
| Bronze | 0–40 | Base position |
| Silver | 41–60 | Default for new users |
| Gold | 61–80 | Priority queue position |
| Platinum | 81–100 | Front-of-line priority |

Queue reorder runs periodically: `POST /api/queue/reorder/:eventId` sorts all sessions by trust score descending.

---

## Live Queue — Real-Time Architecture

- Each queue session gets a Socket.IO room (`session:{sessionId}`)
- Server emits `positionUpdate`, `trustUpdate`, `advance` events
- Client subscribes via `socketService.on(event, handler)`
- `behaviorCollector` runs a 5-second interval streaming behavioral data
- Session persisted to `localStorage` so page refresh doesn't lose position

### Queue Join Flow
```
User clicks event → trivia gate shown
→ user answers → POST /api/queue/join { triviaQuestionId, triviaAnswer }
→ server verifies answer against MongoDB
→ server checks IP for duplicates
→ session created → Socket.IO connected → trust score initialized
```

---

## 3D Stadium System

Built with Three.js + React Three Fiber. Models AT&T Stadium (80,000 seats).

### Modes
| Mode | Controls | Description |
|------|----------|-------------|
| Orbit | Right-drag, scroll | Rotate/zoom the full stadium |
| Walkthrough | WASD, O/L, Space | First-person character navigation |
| Parking | Click lot | Shows parking-to-entrance path |

### Section Detection (`stadiumMath.js`)
- `sectionFromBallPos()` uses Y-band matching (not radial bounds) to identify sections
- Tier configs define lower/club/upper section boundaries
- 4 real stair towers (NE/NW/SE/SW) used for path routing

### Pathfinding (`pathFinder.js`)
- `computePathPlan(fromSection, toSection)` routes through real stair towers
- Outward normal front-face routing for tower entry/exit
- Output fed to TTS service for spoken turn-by-turn directions

### Accessibility Features
- Shortest-path calculation highlights ADA-accessible routes
- TTS directions read aloud via ElevenLabs API (`/api/tts`)
- Parking mode maps specific lots to nearest accessible entrance
- Section highlight persists until user navigates away

### Seat Finder
- Input: section (L1–L54, C1–C22, U1–U36), optional row + seat
- `SeatInstances.jsx` uses instancedMesh for 80K seat rendering performance
- Click handler identifies nearest seat to ray-cast hit

---

## API Reference

### Auth (`/api/auth`)
| Method | Endpoint | Body | Response |
|--------|----------|------|----------|
| POST | `/signup` | `{name, email, password}` | `{token, user}` |
| POST | `/login` | `{email, password}` | `{token, user}` |

### Queue (`/api/queue`)
| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/join` | Join queue; requires trivia answer |
| GET | `/status/:sessionId` | Position, trust, wait time |
| POST | `/leave/:sessionId` | Remove from queue |
| POST | `/location/:sessionId` | Save geolocation for local fan badge |
| POST | `/reorder/:eventId` | Re-rank all sessions by trust |

### Content (`/api/content`)
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/artists` | All artists |
| GET | `/events` | Active events |
| GET | `/artists/:id/trivia` | Trivia questions (AI or static) |
| GET | `/artists/:id/trivia/local` | Location-aware trivia |
| GET | `/artists/:id/polls` | Poll questions |

### Games (`/api/games`)
| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/submit` | Submit answer, receive trust delta |
| GET | `/history/:sessionId` | Past game results |
| POST | `/behavior/stream` | Behavioral data stream |
| GET | `/trust/:sessionId` | Full trust score breakdown |

---

## Database Models

| Model | Key Fields |
|-------|-----------|
| `User` | name, email, password (bcrypt) |
| `QueueSession` | eventId, userId, position, trustScore, trustLevel, isFlagged, ip, locationData |
| `Event` | eventName, venue, date, artistId, coordinates |
| `Artist` | name, genre, imageUrl |
| `TriviaQuestion` | question, options[], correctAnswer, difficulty, artistId, source (db/ai) |
| `PollQuestion` | question, type (choice/slider), options[], artistId |
| `GameResult` | sessionId, gameType, questionId, answer, correct, responseTime, trustDelta |
| `BehavioralStream` | sessionId, events[], score, flagged |

---

## Gemini AI Integration (`geminiService.js`)

- Model: `gemini-2.5-flash` (configured via `GEMINI_MODEL` env var)
- `generateTrivia(artistName, count, difficulty)` → returns structured question objects
- `ensureTriviaPool(artistId)` — checks if DB has < 15 questions before calling Gemini
- Deduplication by question text before `insertMany` prevents duplicates
- Questions saved with real MongoDB `_id`s so the trivia gate can verify them

---

## Deployment

### Production (Free Tier)
| Service | Provider | URL |
|---------|----------|-----|
| Frontend | Vercel | Auto-deploy on `main` push |
| Backend | Render | Auto-deploy on `main` push |
| Database | MongoDB Atlas M0 | 512MB free cluster |

### Environment Variables

**Server:**
```
MONGO_URI          Atlas connection string
JWT_SECRET         Random 32+ char secret
PORT               10000 (Render assigns this)
CORS_ORIGINS       https://your-app.vercel.app
GEMINI_API_KEY     Google AI Studio key
GEMINI_MODEL       gemini-2.5-flash
TICKETMASTER_API_KEY
LASTFM_API_KEY
```

**Frontend:**
```
VITE_API_BASE_URL  https://your-backend.onrender.com/api
VITE_SOCKET_URL    https://your-backend.onrender.com
```

### Docker (Local)
```bash
docker compose up --build -d
# Seed data:
docker compose exec -T server node scripts/seedDatabase.js
docker compose exec -T server node scripts/runSync.js
```

---

## Vite Build Configuration

- Minifier: `esbuild` (faster than terser)
- Manual chunks: `vendor-react`, `vendor-three`, `vendor-r3f`, `vendor-socket`
- Chunk size warning limit: 2500kb (Three.js is large by design)
- Docker build: `NODE_OPTIONS=--max-old-space-size=3072`

---

*Back to [README.md](./README.md)*
